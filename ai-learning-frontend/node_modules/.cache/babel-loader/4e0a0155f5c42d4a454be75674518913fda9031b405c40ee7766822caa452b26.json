{"ast":null,"code":"import httpClient from \"./httpClient\";\nimport axios from \"axios\";\nimport { CONFIG } from \"../config\";\nimport { saveUser } from \"../utils/localStorage\";\n\n/**\r\n * üîê Connexion utilisateur\r\n * @param {string} email\r\n * @param {string} password\r\n * @returns {Promise<{jwt: string, user: object}>}\r\n */\nexport const login = async (email, password) => {\n  try {\n    const {\n      data\n    } = await httpClient.post(\"/auth/local\", {\n      identifier: email,\n      password\n    });\n\n    // Ne pas sauvegarder ici, laisser loginUser dans le contexte le faire\n    // Cela √©vite la double sauvegarde et assure la coh√©rence\n\n    return data;\n  } catch (error) {\n    var _error$response;\n    console.error(\"‚ùå Erreur lors de la connexion :\", ((_error$response = error.response) === null || _error$response === void 0 ? void 0 : _error$response.data) || error.message);\n    throw error;\n  }\n};\n\n/**\r\n * üë§ R√©cup√©rer les informations de l'utilisateur connect√©\r\n * @returns {Promise<object>}\r\n */\nexport const getMe = async () => {\n  try {\n    const {\n      data\n    } = await httpClient.get(\"/users/me?populate=role\");\n    saveUser(data);\n    return data;\n  } catch (error) {\n    var _error$response2;\n    console.error(\"‚ùå Erreur lors de la r√©cup√©ration du profil :\", ((_error$response2 = error.response) === null || _error$response2 === void 0 ? void 0 : _error$response2.data) || error.message);\n    throw error;\n  }\n};\n\n/**\r\n * üìù Inscription utilisateur avec attribution du r√¥le\r\n * @param {string} username\r\n * @param {string} email\r\n * @param {string} password\r\n * @param {string} roleName - Nom du r√¥le (student ou teacher)\r\n * @returns {Promise<{jwt: string, user: object}>}\r\n */\nexport const register = async (username, email, password, roleName) => {\n  try {\n    var _rolesRes, _rolesRes$roles;\n    // Validation des param√®tres\n    if (!username || !email || !password) {\n      throw new Error(\"Tous les champs sont requis\");\n    }\n\n    // √âtape 1: Cr√©er l'utilisateur (Strapi n'accepte pas le param√®tre role dans /auth/local/register)\n    let registerRes;\n    try {\n      const response = await httpClient.post(\"/auth/local/register\", {\n        username: username.trim(),\n        email: email.trim().toLowerCase(),\n        password\n      });\n      registerRes = response.data;\n    } catch (registerError) {\n      var _registerError$respon;\n      // G√©rer les erreurs de validation Strapi\n      const errorData = (_registerError$respon = registerError.response) === null || _registerError$respon === void 0 ? void 0 : _registerError$respon.data;\n      if (errorData !== null && errorData !== void 0 && errorData.error) {\n        var _errorData$error$deta;\n        const errorMessage = errorData.error.message || \"Erreur lors de l'inscription\";\n\n        // Extraire les d√©tails d'erreur si disponibles\n        if ((_errorData$error$deta = errorData.error.details) !== null && _errorData$error$deta !== void 0 && _errorData$error$deta.errors) {\n          const errors = errorData.error.details.errors;\n          const firstError = Object.values(errors)[0];\n          if (firstError && firstError[0]) {\n            throw new Error(firstError[0].message || errorMessage);\n          }\n        }\n        throw new Error(errorMessage);\n      }\n      throw registerError;\n    }\n    if (!registerRes || !registerRes.jwt || !registerRes.user) {\n      throw new Error(\"R√©ponse invalide du serveur lors de l'inscription\");\n    }\n    const token = registerRes.jwt;\n    const userId = registerRes.user.id;\n\n    // √âtape 2: R√©cup√©rer tous les r√¥les disponibles (sans token car route publique)\n    let rolesRes;\n    try {\n      const response = await httpClient.get(\"/users-permissions/roles\");\n      rolesRes = response.data;\n    } catch (rolesError) {\n      console.warn(\"‚ö†Ô∏è Impossible de r√©cup√©rer les r√¥les:\", rolesError);\n      // Si on ne peut pas r√©cup√©rer les r√¥les, retourner les donn√©es de base\n      return {\n        jwt: token,\n        user: registerRes.user\n      };\n    }\n\n    // √âtape 3: Trouver le r√¥le s√©lectionn√©\n    const selectedRole = (_rolesRes = rolesRes) === null || _rolesRes === void 0 ? void 0 : (_rolesRes$roles = _rolesRes.roles) === null || _rolesRes$roles === void 0 ? void 0 : _rolesRes$roles.find(r => r.name.toLowerCase() === roleName.toLowerCase());\n    if (!selectedRole) {\n      console.warn(`‚ö†Ô∏è R√¥le \"${roleName}\" introuvable, utilisation du r√¥le par d√©faut`);\n      // Retourner les donn√©es de base si le r√¥le n'est pas trouv√©\n      return {\n        jwt: token,\n        user: registerRes.user\n      };\n    }\n\n    // √âtape 4: Mettre √† jour le r√¥le de l'utilisateur avec le token JWT obtenu\n    // On utilise axios directement car httpClient utilise le token du localStorage qui n'existe pas encore\n    try {\n      await axios.put(`${CONFIG.API_URL}/users/${userId}`, {\n        role: selectedRole.id\n      }, {\n        headers: {\n          Authorization: `Bearer ${token}`,\n          \"Content-Type\": \"application/json\"\n        }\n      });\n\n      // √âtape 5: R√©cup√©rer les donn√©es utilisateur mises √† jour avec le r√¥le\n      const {\n        data: updatedUser\n      } = await axios.get(`${CONFIG.API_URL}/users/${userId}?populate=role`, {\n        headers: {\n          Authorization: `Bearer ${token}`\n        }\n      });\n\n      // Retourner les donn√©es avec le r√¥le mis √† jour\n      return {\n        jwt: token,\n        user: updatedUser\n      };\n    } catch (updateError) {\n      var _updateError$response;\n      // Si la mise √† jour du r√¥le √©choue, retourner quand m√™me les donn√©es de base\n      console.warn(\"‚ö†Ô∏è Impossible de mettre √† jour le r√¥le, l'utilisateur a √©t√© cr√©√© avec le r√¥le par d√©faut:\", ((_updateError$response = updateError.response) === null || _updateError$response === void 0 ? void 0 : _updateError$response.data) || updateError.message);\n\n      // Retourner les donn√©es de base m√™me si la mise √† jour du r√¥le √©choue\n      return {\n        jwt: token,\n        user: registerRes.user\n      };\n    }\n  } catch (error) {\n    var _error$response3;\n    console.error(\"‚ùå Erreur lors de l'inscription :\", ((_error$response3 = error.response) === null || _error$response3 === void 0 ? void 0 : _error$response3.data) || error.message);\n    throw error;\n  }\n};\n\n/**\r\n * üö™ D√©connexion utilisateur\r\n */\nexport const logout = () => {\n  clearAuthData();\n};","map":{"version":3,"names":["httpClient","axios","CONFIG","saveUser","login","email","password","data","post","identifier","error","_error$response","console","response","message","getMe","get","_error$response2","register","username","roleName","_rolesRes","_rolesRes$roles","Error","registerRes","trim","toLowerCase","registerError","_registerError$respon","errorData","_errorData$error$deta","errorMessage","details","errors","firstError","Object","values","jwt","user","token","userId","id","rolesRes","rolesError","warn","selectedRole","roles","find","r","name","put","API_URL","role","headers","Authorization","updatedUser","updateError","_updateError$response","_error$response3","logout","clearAuthData"],"sources":["C:/gi4/Prijects/AI_Educative/ai-learning-frontend/src/api/auth.js"],"sourcesContent":["import httpClient from \"./httpClient\";\r\nimport axios from \"axios\";\r\nimport { CONFIG } from \"../config\";\r\nimport { saveUser, } from \"../utils/localStorage\";\r\n\r\n/**\r\n * üîê Connexion utilisateur\r\n * @param {string} email\r\n * @param {string} password\r\n * @returns {Promise<{jwt: string, user: object}>}\r\n */\r\nexport const login = async (email, password) => {\r\n  try {\r\n    const { data } = await httpClient.post(\"/auth/local\", {\r\n      identifier: email,\r\n      password,\r\n    });\r\n    \r\n    // Ne pas sauvegarder ici, laisser loginUser dans le contexte le faire\r\n    // Cela √©vite la double sauvegarde et assure la coh√©rence\r\n    \r\n    return data;\r\n  } catch (error) {\r\n    console.error(\"‚ùå Erreur lors de la connexion :\", error.response?.data || error.message);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * üë§ R√©cup√©rer les informations de l'utilisateur connect√©\r\n * @returns {Promise<object>}\r\n */\r\nexport const getMe = async () => {\r\n  try {\r\n    const { data } = await httpClient.get(\"/users/me?populate=role\");\r\n    saveUser(data);\r\n    return data;\r\n  } catch (error) {\r\n    console.error(\"‚ùå Erreur lors de la r√©cup√©ration du profil :\", error.response?.data || error.message);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * üìù Inscription utilisateur avec attribution du r√¥le\r\n * @param {string} username\r\n * @param {string} email\r\n * @param {string} password\r\n * @param {string} roleName - Nom du r√¥le (student ou teacher)\r\n * @returns {Promise<{jwt: string, user: object}>}\r\n */\r\nexport const register = async (username, email, password, roleName) => {\r\n  try {\r\n    // Validation des param√®tres\r\n    if (!username || !email || !password) {\r\n      throw new Error(\"Tous les champs sont requis\");\r\n    }\r\n\r\n    // √âtape 1: Cr√©er l'utilisateur (Strapi n'accepte pas le param√®tre role dans /auth/local/register)\r\n    let registerRes;\r\n    try {\r\n      const response = await httpClient.post(\"/auth/local/register\", {\r\n        username: username.trim(),\r\n        email: email.trim().toLowerCase(),\r\n        password,\r\n      });\r\n      registerRes = response.data;\r\n    } catch (registerError) {\r\n      // G√©rer les erreurs de validation Strapi\r\n      const errorData = registerError.response?.data;\r\n      if (errorData?.error) {\r\n        const errorMessage = errorData.error.message || \"Erreur lors de l'inscription\";\r\n        \r\n        // Extraire les d√©tails d'erreur si disponibles\r\n        if (errorData.error.details?.errors) {\r\n          const errors = errorData.error.details.errors;\r\n          const firstError = Object.values(errors)[0];\r\n          if (firstError && firstError[0]) {\r\n            throw new Error(firstError[0].message || errorMessage);\r\n          }\r\n        }\r\n        \r\n        throw new Error(errorMessage);\r\n      }\r\n      throw registerError;\r\n    }\r\n\r\n    if (!registerRes || !registerRes.jwt || !registerRes.user) {\r\n      throw new Error(\"R√©ponse invalide du serveur lors de l'inscription\");\r\n    }\r\n\r\n    const token = registerRes.jwt;\r\n    const userId = registerRes.user.id;\r\n\r\n    // √âtape 2: R√©cup√©rer tous les r√¥les disponibles (sans token car route publique)\r\n    let rolesRes;\r\n    try {\r\n      const response = await httpClient.get(\"/users-permissions/roles\");\r\n      rolesRes = response.data;\r\n    } catch (rolesError) {\r\n      console.warn(\"‚ö†Ô∏è Impossible de r√©cup√©rer les r√¥les:\", rolesError);\r\n      // Si on ne peut pas r√©cup√©rer les r√¥les, retourner les donn√©es de base\r\n      return {\r\n        jwt: token,\r\n        user: registerRes.user,\r\n      };\r\n    }\r\n    \r\n    // √âtape 3: Trouver le r√¥le s√©lectionn√©\r\n    const selectedRole = rolesRes?.roles?.find(\r\n      (r) => r.name.toLowerCase() === roleName.toLowerCase()\r\n    );\r\n\r\n    if (!selectedRole) {\r\n      console.warn(`‚ö†Ô∏è R√¥le \"${roleName}\" introuvable, utilisation du r√¥le par d√©faut`);\r\n      // Retourner les donn√©es de base si le r√¥le n'est pas trouv√©\r\n      return {\r\n        jwt: token,\r\n        user: registerRes.user,\r\n      };\r\n    }\r\n\r\n    // √âtape 4: Mettre √† jour le r√¥le de l'utilisateur avec le token JWT obtenu\r\n    // On utilise axios directement car httpClient utilise le token du localStorage qui n'existe pas encore\r\n    try {\r\n      await axios.put(\r\n        `${CONFIG.API_URL}/users/${userId}`,\r\n        {\r\n          role: selectedRole.id,\r\n        },\r\n        {\r\n          headers: {\r\n            Authorization: `Bearer ${token}`,\r\n            \"Content-Type\": \"application/json\",\r\n          },\r\n        }\r\n      );\r\n\r\n      // √âtape 5: R√©cup√©rer les donn√©es utilisateur mises √† jour avec le r√¥le\r\n      const { data: updatedUser } = await axios.get(\r\n        `${CONFIG.API_URL}/users/${userId}?populate=role`,\r\n        {\r\n          headers: {\r\n            Authorization: `Bearer ${token}`,\r\n          },\r\n        }\r\n      );\r\n\r\n      // Retourner les donn√©es avec le r√¥le mis √† jour\r\n      return {\r\n        jwt: token,\r\n        user: updatedUser,\r\n      };\r\n    } catch (updateError) {\r\n      // Si la mise √† jour du r√¥le √©choue, retourner quand m√™me les donn√©es de base\r\n      console.warn(\r\n        \"‚ö†Ô∏è Impossible de mettre √† jour le r√¥le, l'utilisateur a √©t√© cr√©√© avec le r√¥le par d√©faut:\",\r\n        updateError.response?.data || updateError.message\r\n      );\r\n      \r\n      // Retourner les donn√©es de base m√™me si la mise √† jour du r√¥le √©choue\r\n      return {\r\n        jwt: token,\r\n        user: registerRes.user,\r\n      };\r\n    }\r\n  } catch (error) {\r\n    console.error(\"‚ùå Erreur lors de l'inscription :\", error.response?.data || error.message);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * üö™ D√©connexion utilisateur\r\n */\r\nexport const logout = () => {\r\n  clearAuthData();\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}